# Calculating morphological and intensity parameters

The text files containing outlines generated by Cellpose 2.0 were used along with the processed DPC images to calculate morphological and intensity parameters of each cell. The measurements were performed using ImageJ in the cluster in [“headless”](https://imagej.net/scripting/headless) mode. 

All the files are saved and the computations are done in the compute nodes themselves - computations are much faster when the data is stored in the local storage of the compute node (in this case `$SLURM_TMPDIR` of the compute node) than in the login node, especially when large number of small computations are required (such as in this case, where thousands of outline files need to be processed one at a time). The following procedure is followed: 
- Outline files are archived in the local storage of the compute node in `$SLURM_TMPDIR`
- Outline files are unarchived in the local storage `$SLURM_TMPDIR/Outlines`
- Python programs e.g. `imagej_roi_converter_CC_Archive.py` are saved in $SLURM_TMPDIR
- Imagej is run in headless mode and results saved in `$SLURM_TMPDIR/MorphParam`
- Result files are archived and saved in local node, e.g. `/home/shrestha/projects/def-stoeber/shrestha/MorphologicalParameters/Nepal/[UID]`

The python programs open the outline files with corresponding image files to calculate the required morphological and intensity parameters. The following python files are included: 
- `imagej_roi_converter_CC_Archive.py`: For processing Nepal data
- `imagej_roi_converter_CC_ArchiveCanada.py`: For processing Canada data
- `imagej_roi_converter_CC_ArchiveCanadaR.py`: For processing Canada data (repeats - this includes correction for ZeroDivisionErrors)
- `imagej_roi_converter_CC_ArchiveCanadaTimeSeries.py`: For processing Canada time series data

The shell scripts are used to submit the jobs and run ImageJ in headless mode using the python programs: 
- `runMPnArchive.sh`: For Nepal data
- `runMPcArchive.sh`: For Canada data
- `runMPcArchiveTimeSeries.sh`: For Canada time series data

Sample sbatch commands for Canada data are provided:
```
sbatch --time=12:00:00 --array=1 runMPcArchive.sh     
sbatch --time=14:00:00 --array=2-3 runMPcArchive.sh
sbatch --time=16:00:00 --array=4-5 runMPcArchive.sh
sbatch --time=23:00:00 --array=6-11 runMPcArchive.sh
sbatch --time=1-04:00:00 --array=12-15 runMPcArchive.sh
sbatch --time=1-08:00:00 --array=16-17 runMPcArchive.sh
sbatch --time=1-11:00:00 --array=18-20 runMPcArchive.sh
sbatch --time=1-16:00:00 --array=21-22 runMPcArchive.sh
sbatch --time=1-19:00:00 --array=23-24 runMPcArchive.sh
sbatch --time=1-21:00:00 --array=25-26 runMPcArchive.sh
sbatch --time=2-03:00:00 --array=27-28 runMPcArchive.sh
sbatch --time=2-11:00:00 --array=29 runMPcArchive.sh
```
